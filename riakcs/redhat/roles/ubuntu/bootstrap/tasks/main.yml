---
- name: Create groups based on distribution
  group_by: key={{ ansible_distribution }}

- name: mount the riak volume with optmized settings
  mount: name={{ riak.mountpoint }} src={{ riak.partition }} opts="noatime,barrier=0,errors=remount-ro" fstype=ext4 state=mounted

- name: confgure rc.local
  template: src=etc_rc.local.j2 dest=/etc/rc.local owner=root group=root mode=0755
  notify: source rclocal

- name: create sysctl.d
  file: dest=/etc/sysctl.d state=directory
- name: configure sysctl
  copy: src=etc_sysctl.d_riak.conf dest=/etc/sysctl.d/riak.conf owner=root group=root mode=0644
  notify: update sysctl

- name: update pam configuration
  lineinfile: line="session    required   pam_limits.so" dest={{ item }} regexp="session    required   pam_limits.so" insertafter="^# end of pam-auth-update config"
  with_items:
    - /etc/pam.d/common-session
    - /etc/pam.d/common-session-noninteractive

- name: configure iptables
  template: src=../../common/templates/iptables.j2 dest=/etc/iptables.rules owner=root group=root
  notify:
  - restore iptables

- name: get the basho apt key
  apt_key: url=http://apt.basho.com/gpg/basho.apt.key state=present

- name: configure the basho repository
  template: src=etc_apt_sources.list.d_basho.list.j2 dest=/etc/apt/sources.list.d/basho.list

- name: update repository cache
  apt: update_cache=yes

#install packages outside of roles because they are cross dependent
- name: install riak,riakcs
  apt: pkg=$item
  with_items:
  - riak
  - riak-cs